AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
<<<<<<< HEAD
  samNode

  Sample SAM Template for samNode
  
###### PARAMETERS - ENV VAR - STOLEN LAYOUT FROM DR ####
Parameters:
  #DataRegisterNameAPIKey:
  #  Type: String
  #  Default: 'getFromDev?'
  #DataRegistryURL:
  #  Type: String
  #  Default: 'getFromDev?'
  AWSAccountList:
    Type: String
    Default: 'default'
  WebHookURL:
    Type: String
    Default: 'default'
  Algorithm:
    Type: String
    Default: "HS384"
  ExportFunctionName:
    Type: String
    Default: "parks-reso-api-api-exportAllPassInvokable"
  ExportExpiryTime:
    Type: String
    Default: "15"
  DisableProgressUpdates:
    Type: String
    Default: "True"
  FileName:
    Type: String
    Default: "DUP_EXPORT"
  TableName:
    Type: String
    Default: parksRESo
  S3BucketData:
    Type: String
    Default: "Bucket"
  JWTSecret:
    Type: String
    Default: "SECRET"
  JWTSignExpiry:
    Type: String
    Default: 'Default_Secret'
  PrivateKey:
    Type: String
    Default: 'DEfaultKey'
  PublicFrontend:
    Type: String
    Default: "Public FrontEnd"
  PassCancellationRoute:    
    Type: String
    Default: "CANCEL HERE"
  GCNotifyApiPath:
    Type: String
    Default: "API_PATH"
  GCNotifyCancelTemplateID:
    Type: String
    Default: "CANCEL TEMPLATE ID"
  PassShortdateIndex:
    Type: String
    Default: "Index"
  GCNotifyIsSendingReminders:
    Type: String
    Default: "True"
  GCNotifyApiBulkPath:
    Type: String
    Default: "String"
  GCNotifyApiKey:
    Type: String
    Default: "KEY"
  FeedbackSurveyUrl:
    Type: String
    Default: "URL"
  GCNotifyIsSendingSurveys:
    Type: String
    Default: "NO"
  GCNotifySurveyTempalteID:
    Type: String
    Default: "String"
  GCNotifyTrailReceiptTemplateID:
    Type: String
    Default: "Default"
  GCNotifyParkingReceiptTemplateID:
    Type: String
    Default: "ID"
  LogLevel:
    Type: String
    Default: 'error'
  MetricsTableName:
    Type: String
    Default: 'parksreso-metrics'
  MetaTableName:
    Type: String
    Default: 'parksreso-meta'
  AWSDefaultRegion:
    Type: String
    Default: 'ca-central-1'
  AWSRegion:
    Type: String
    Default: 'String'
  PassManagementRoute:
    Type: String
    Default: "PassMR?"
  AdminFrontEnd:
    Type: String
    Default: "String"
  SSOIssuer:
    Type: String
    Default: 'String'
  SSOJWKSUri:
    Type: String
    Default: 'String'
  LowCapacityThreshold:
    Type: String
    Default: '0.25'
  ModerateCapacityThreshold:
    Type: String
    Default: '0.75'
  GCNotifySMSTemplateID:
    Type: String
    Default: 'String'
  GCNotifyApiSMSPath:
    Type: String
    Default: 'String'
  SqsQueueName:
    Type: String
    Default: 'String'
  GCNotifyReminderTemplateID:
    Type: String
    Default: 'SSSSSS'
  
      
Globals:
    Api:
        Cors:
            AllowMethods: "'POST,GET,OPTIONS, PUT'"
            AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-App-Version'"
            AllowOrigin: "'*'"

Resources:

  ###LAYERS###
=======
  SAM deployment for Day Use Pass API
  
# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 30
    Environment:
      Variables:
        SSO_ISSUER: !Ref SSOIssuerUrl
        SSO_JWKSURI: !Ref SSOJWKSUri
        IS_OFFLINE: false
        AWSREGION: !Ref AWSDefaultRegion
        DYNAMODB_ENDPOINT_URL: "http://172.17.0.2:8000"

Parameters:
  Algorithm:
    Type: String
    Default: "HS384"
  AdminFrontEnd:
    Type: String
    Default: "http://localhost:4200/dayuse"
  AWSAccountList:
    Type: String
    Default: 'default'
  AWSDefaultRegion:
    Type: String
    Default: 'ca-central-1'
  CFSecretKey:
    Type: String
    Default: '1x0000000000000000000000000000000AA'
  DataRegisterApiPath:
    Type: String
    Default: 'https://data.bcparks.ca/api'
  DataRegisterApiKey:
    Type: String
    Default: 'String'
  DisableProgressUpdates:
    Type: String
    Default: false
  ExportExpiryTime:
    Type: String
    Default: '15'
  ExportFunctionName:
    Type: String
    Default: 'dup-api-exportAllPassInvokable'
  FeedbackSurveyUrl:
    Type: String
    Default: 'https://helpshapebc.gov.bc.ca/dup-park-experience-survey'
  FileName:
    Type: String
    Default: 'DUP_EXPORT'
  GCNotifyApiBulkPath:
    Type: String
    Default: 'https://api.notification.canada.ca/v2/notifications/bulk'
  GCNotifyApiKey:
    Type: String
    Default: 'String'
  GCNotifyApiPath:
    Type: String
    Default: 'https://api.notification.canada.ca/v2/notifications/email'
  GCNotifyApiSMSPath:
    Type: String
    Default: 'https://api.notification.canada.ca/v2/notifications/sms'
  GCNotifyCancelTemplateID:
    Type: String
    Default: 'String'
  GCNotifyIsSendingReminders:
    Type: String
    Default: 'true'
  GCNotifyIsSendingSurveys:
    Type: String
    Default: 'true'
  GCNotifyParkingReceiptTemplateID:
    Type: String
    Default: 'String'
  GCNotifyPassCancellationRoute:
    Type: String
    Default: '/pass-lookup'
  GCNotifyPassManagementRoute:
    Type: String
    Default: '/pass-management/check-in'
  GCNotifyReminderTemplateID:
    Type: String
    Default: 'SSSSSS'
  GCNotifySMSTemplateID:
    Type: String
    Default: 'String'
  GCNotifySurveyTemplateID:
    Type: String
    Default: 'String'
  GCNotifyTrailReceiptTemplateID:
    Type: String
    Default: 'String'
  HoldPassTimeout:
    Type: String
    Default: '7m'
  JWTSecret:
    Type: String
    Default: 'String'
  LogLevel:
    Type: String
    Default: 'error'
  LowCapacityThreshold:
    Type: String
    Default: '0.25'
  MetaTableName:
    Type: String
    Default: 'ParksMetaDUP'
  MetricsTableName:
    Type: String
    Default: 'ParksMetricsDUP'
  ModerateCapacityThreshold:
    Type: String
    Default: '0.75'
  PassShortDateIndex:
    Type: String
    Default: 'shortPassDate-index'
  PublicFrontend:
    Type: String
    Default: 'http://localhost:4300/dayuse'
  S3BucketData:
    Type: String
    Default: 'parks-dup-assets-tools'
  SSOIssuerUrl:
    Type: String
    Default: 'https://dev.loginproxy.gov.bc.ca/auth/realms/bcparks-service-transformation'
  SSOJWKSUri:
    Type: String
    Default: 'https://dev.loginproxy.gov.bc.ca/auth/realms/bcparks-service-transformation/protocol/openid-connect/certs'
  Stage:
    Type: String
    Default: 'api'
  SqsGCNQueueName:
    Type: String
    Default: 'gcn-email-queue-sam'
  SqsExpiryQueueName:
    Type: String
    Default: 'expiry-queue-sam'
  TableNameParks:
    Type: String
    Default: 'ParksDUP'
  WebHookURL:
    Type: String
    Default: 'default'
  
Resources:
  #########
  # Layers
  #########
>>>>>>> 00b1f9f... Sam Build Files
  BaseLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: baseLayer
      Description: Utilities Base Layer
      ContentUri: layers/baseLayer/
      CompatibleRuntimes:
        - nodejs20.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile

<<<<<<< HEAD
  ExportAllPassLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: exportAllPassLayer
      Description: Data Register Utilities Layer
      ContentUri: layers/exportAllPassUtil/
      CompatibleRuntimes:
        - nodejs18.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile

=======
>>>>>>> 00b1f9f... Sam Build Files
  DataRegisterLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: dataRegisterLayer
      Description: Data Register Utilities Layer
<<<<<<< HEAD
      ContentUri: layers/dataRegisterUtil/
=======
      ContentUri: layers/dataRegisterLayer/
>>>>>>> 00b1f9f... Sam Build Files
      CompatibleRuntimes:
        - nodejs20.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile

<<<<<<< HEAD
  MetricsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: metricsLayer
      Description: Metrics Utilities Layer
      ContentUri: layers/metricsUtil/
=======
  ExportAllPassLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: exportAllPassLayer
      Description: Data Register Utilities Layer
      ContentUri: layers/exportAllPassLayer/
>>>>>>> 00b1f9f... Sam Build Files
      CompatibleRuntimes:
        - nodejs20.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile

<<<<<<< HEAD

=======
>>>>>>> 00b1f9f... Sam Build Files
  FacilityLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: facilityLayer
      Description: Facility Utilities Layer
<<<<<<< HEAD
      ContentUri: layers/facilityUtil/
      CompatibleRuntimes:
        - nodejs18.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile

  PassLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: passLayer
      Description: Pass Utilities Layer
      ContentUri: layers/passUtil/
=======
      ContentUri: layers/facilityLayer/
>>>>>>> 00b1f9f... Sam Build Files
      CompatibleRuntimes:
        - nodejs20.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile

<<<<<<< HEAD
  CaptchaLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: captchaLayer
      Description: Captcha Utilities Layer
      ContentUri: layers/captchaLayer/
      CompatibleRuntimes:
        - nodejs18.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile
  
  SQSLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: sqsLayer
      Description: SQS Utilities Layer
      ContentUri: layers/sqsUtil/
      CompatibleRuntimes:
        - nodejs18.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile
  
=======
>>>>>>> 00b1f9f... Sam Build Files
  GCNotifyLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: gcNotifyLayer
      Description: GC Notify Utilities Layer
<<<<<<< HEAD
      ContentUri: layers/gcNotifyUtil/
=======
      ContentUri: layers/gcNotifyLayer/
>>>>>>> 00b1f9f... Sam Build Files
      CompatibleRuntimes:
        - nodejs20.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile

<<<<<<< HEAD
  WebHookLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: webHookLayer
      Description: Parks Data Register WebHook Layer
      ContentUri: layers/webHookUtil/
=======
  JWTLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: JWTLayer
      Description: Utilities JWT Layer
      ContentUri: layers/jwtLayer/
>>>>>>> 00b1f9f... Sam Build Files
      CompatibleRuntimes:
        - nodejs20.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile

<<<<<<< HEAD
  SMSLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: smsUtil
      Description: SMS Utilities Layer
      ContentUri: layers/smsUtil/
=======
  MetricsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: metricsLayer
      Description: Metrics Utilities Layer
      ContentUri: layers/metricsLayer/
>>>>>>> 00b1f9f... Sam Build Files
      CompatibleRuntimes:
        - nodejs20.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile

<<<<<<< HEAD
  DynamoDBLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: dynamodb
      Description: Parks Data Register DynamoDB Utilities Layer
      ContentUri: layers/dynamodb/
=======
  PassLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: passLayer
      Description: Pass Utilities Layer
      ContentUri: layers/passLayer/
>>>>>>> 00b1f9f... Sam Build Files
      CompatibleRuntimes:
        - nodejs20.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile
<<<<<<< HEAD
  
  ResponseLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: responseLayer
      Description: Response Utilities layer
      ContentUri: layers/responseUtil
=======

  PermissionLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: PermissionLayer
      Description: Permission Utilities layer
      ContentUri: layers/permissionLayer/
>>>>>>> 00b1f9f... Sam Build Files
      CompatibleRuntimes:
        - nodejs20.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile
<<<<<<< HEAD
  
  LoggerLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: LoggerLayer
      Description: Logger Utilities layer
      ContentUri: layers/loggerUtil
=======

  ReservationLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: ReservationLayer
      Description: Reservation Utilities layer
      ContentUri: layers/reservationLayer/
>>>>>>> 00b1f9f... Sam Build Files
      CompatibleRuntimes:
        - nodejs20.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile
<<<<<<< HEAD
    
  PermissionLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: PermissionLayer
      Description: Permission Utilities layer
      ContentUri: layers/permissionUtil
=======

  SMSLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: smsUtil
      Description: SMS Utilities Layer
      ContentUri: layers/smsLayer/
>>>>>>> 00b1f9f... Sam Build Files
      CompatibleRuntimes:
        - nodejs20.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile
<<<<<<< HEAD
  
  ReservationLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: ReservationLayer
      Description: Reservation Utilities layer
      ContentUri: layers/reservationUtil
=======

  WebHookLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: webHookLayer
      Description: Parks Data Register WebHook Layer
      ContentUri: layers/webHookLayer/
>>>>>>> 00b1f9f... Sam Build Files
      CompatibleRuntimes:
        - nodejs20.x
      LicenseInfo: 'Apache-2.0'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: makefile

<<<<<<< HEAD
  
  
  ###FUNCTIONS###
  sendSurvey:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: sendSurvey/
=======
  ############
  # Functions
  ############
  CheckActivationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/checkActivation/
>>>>>>> 00b1f9f... Sam Build Files
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
<<<<<<< HEAD
          PASS_SHORTDATE_INDEX: !Ref PassShortdateIndex
          FEEDBACK_SURVEY_URL: !Ref FeedbackSurveyUrl
          GC_NOTIFY_IS_SENDING_SURVEYS: !Ref GCNotifyIsSendingSurveys
          GC_NOTIFY_SURVEY_TEMPLATE_ID: !Ref GCNotifySurveyTempalteID
          GC_NOTIFY_API_BULK_PATH: !Ref GCNotifyApiBulkPath
          GC_NOTIFY_API_KEY: !Ref GCNotifyApiKey
          WEBHOOK_URL: !Ref WebHookURL
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          JWT_SECRET: !Ref JWTSecret
          JWT_SIGN_EXPIRY: !Ref JWTSignExpiry
          PRIVATE_KEY: !Ref PrivateKey
          AWS_DEFAULT_REGION: !Ref AWSDefaultRegion
          ALGORITH: !Ref Algorithm
      Layers:
          - !Ref CaptchaLayer
          - !Ref BaseLayer


  warmupFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: warmup/
=======
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        ScheduleEvent:
          Type: Schedule
          Properties:
            Schedule: "cron(0 0 * * ? *)" #  Every night at midnight

  CheckExpiryFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/checkExpiry/
>>>>>>> 00b1f9f... Sam Build Files
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
<<<<<<< HEAD
          JWT_SECRET: !Ref JWTSecret
          JWT_SIGN_EXPIRY: !Ref JWTSignExpiry
          PRIVATE_KEY: !Ref PrivateKey
          AWS_DEFAULT_REGION: !Ref AWSDefaultRegion
          ALGORITHM: !Ref Algorithm
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref CaptchaLayer
          - !Ref ResponseLayer
          - !Ref LoggerLayer     


  generateCaptchaAudio:
    Type: AWS::Serverless::Function
    Properties:
      Environment: 
        Variables:
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          JWT_SECRET: !Ref JWTSecret
          JWT_SIGN_EXPIRY: !Ref JWTSignExpiry
          PRIVATE_KEY: !Ref PrivateKey
          AWS_DEFAULT_REGION: !Ref AWSDefaultRegion
          ALGORITH: !Ref Algorithm
      CodeUri: generateAudio/
      Timeout: 60
      Handler: index.handler
      Runtime: nodejs18.x
      Layers:
          - !Ref BaseLayer
          - !Ref CaptchaLayer      
      Events:
        verifyCaptcha:
          Type: Api
          Properties:
            Path: /captcha/audio
            Method: post

  verifyCaptcha:
    Type: AWS::Serverless::Function
    Properties:
<<<<<<< HEAD
      CodeUri: verifyCaptcha/
=======
      CodeUri: handlers/cloudWatchAlarm/
      Handler: index.handler
      Runtime: nodejs20.x
>>>>>>> 29a2062... convert to use npm, update github actions
      Environment:
        Variables:
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
      Handler: index.handler
      Timeout: 60
      Runtime: nodejs18.x
      Layers:
          - !Ref BaseLayer      
      Events:
        verifyCaptcha:
          Type: Api
          Properties:
            Path: /captcha/verify
            Method: post


  generateCaptcha:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: generateCaptcha/
      Handler: index.handler
<<<<<<< HEAD
      Timeout: 60
      Runtime: nodejs18.x
=======
      Runtime: nodejs20.x
>>>>>>> 29a2062... convert to use npm, update github actions
      Environment:
        Variables:
          PRIVATE_KEY: !Ref PrivateKey
          JWT_SECRET: !Ref JWTSecret
          JWT_SIGN_EXPIRY: !Ref JWTSignExpiry
          ALGORITHM: !Ref Algorithm
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          PASS_MANAGEMENT_ROUTE: !Ref PassManagementRoute
          ADMIN_FRONTEND: !Ref AdminFrontEnd

      Layers:
          - !Ref BaseLayer
          - !Ref PassLayer
      Events:
        generateCaptcha:
          Type: Api
          Properties:
            Path: /captcha
            Method: post


  SQSProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: sqsProcessor/
      Timeout: 60
      Handler: index.handler
      Runtime: nodejs18.x
      Environment:
        Variables:
          GC_NOTIFY_API_PATH: !Ref GCNotifyApiPath
          GC_NOTIFY_API_KEY: !Ref GCNotifyApiKey
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer         


  WriteConfigFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: writeConfig/
      Handler: index.handler
      Timeout: 60
      Runtime: nodejs18.x
      Environment:
        Variables:
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          SSO_ISSUER: !Ref SSOIssuer
          SSO_JWKSURI: !Ref SSOJWKSUri
      Layers:
          - !Ref PermissionLayer
          - !Ref BaseLayer         
      Events:
        writeConfig:
          Type: Api
          Properties:
            Path: /config
            Method: post


  WriteModifierFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: writeModifier/
      Handler: index.handler
      Timeout: 60
      Runtime: nodejs18.x
      Environment:
        Variables:
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          SSO_ISSUER: !Ref SSOIssuer
          SSO_JWKSURI: !Ref SSOJWKSUri
          MODERATE_CAPACITY_THRESHOLD: !Ref ModerateCapacityThreshold
          LOW_CAPACITY_THRESHOLD: !Ref LowCapacityThreshold
      Layers:
          - !Ref PermissionLayer
          - !Ref BaseLayer
          - !Ref FacilityLayer
          - !Ref ReservationLayer         
      Events:
        writeModifier:
          Type: Api
          Properties:
            Path: /modifier
            Method: put



  ExportAllPassInvokableFunction:   
    Type: AWS::Serverless::Function
    Properties:
      Handler: index.handler
      CodeUri: exportAllPass/invokable/
      Runtime: nodejs18.x
      Environment:
        Variables:
          DISABLE_PROGRESS_UPDATES: !Ref DisableProgressUpdates
          FILE_NAME: !Ref FileName
          S3_BUCKET_DATA: !Ref S3BucketData

  ExportAllPassGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: exportAllPass/GET/
      Timeout: 60
=======
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        ScheduleEvent:
          Type: Schedule
          Properties:
            Schedule: "cron(0 0 * * ? *)" #  Every night at midnight       

  CloudWatchFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/cloudWatchAlarm/
      Handler: index.handler
      Runtime: nodejs18.x
      Environment:
        Variables:
          AWS_ACCOUNT_LIST: !Ref AWSAccountList
          WEBHOOK_URL: !Ref WebHookURL
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        MyCloudWatchEvent:
          Type: CloudWatchEvent
          Properties:
            Pattern:
              source:
                - "aws.cloudwatch"
              detail-type:
                - "Scheduled Event"

  DeletePassFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: handlers/deletePass/
      Handler: index.handler
      Runtime: nodejs18.x
      Environment:
        Variables:
          ALGORITHM: !Ref Algorithm
          JWT_SECRET: !Ref JWTSecret
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKSURI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TableNameParks
        - DynamoDBCrudPolicy:
            TableName: !Ref MetaTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref MetricsTableName
      Events:
        deletePass:
          Type: Api
          Properties:
            Path: /pass
            Method: DELETE
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true

  ExportAllPassGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/exportAllPass/GET
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          EXPORT_FUNCTION_NAME: !Ref ExportFunctionName
          EXPORT_EXPIRY_TIME: !Ref ExportExpiryTime
          S3_BUCKET_DATA: !Ref S3BucketData
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKS_URI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref ExportAllPassLayer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TableNameParks
        - DynamoDBCrudPolicy:
            TableName: !Ref MetaTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref MetricsTableName
        - LambdaInvokePolicy:
            FunctionName:
              !Ref ExportFunctionName
        - S3FullAccessPolicy:
            BucketName: !Ref S3BucketData
      Events:
        exportAllPassGet:
          Type: Api
          Properties:
            Path: /export-all-pass
            Method: GET
            RestApiId: !Ref ApiDeployment
        exportAllPassOptions:
          Type: Api
          Properties:
            Path: /export-all-pass
            Method: OPTIONS
            RestApiId: !Ref ApiDeployment

  ExportAllPassInvokableFunction:        
    Type: AWS::Serverless::Function
    Properties:
      Handler: index.handler
      CodeUri: handlers/exportAllPass/invokable/
      Runtime: nodejs20.x
      FunctionName: !Ref ExportFunctionName
      Environment:
        Variables:
          DISABLE_PROGRESS_UPDATES: !Ref DisableProgressUpdates
          FILE_NAME: !Ref FileName
          S3_BUCKET_DATA: !Ref S3BucketData
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref ExportAllPassLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
          - S3FullAccessPolicy:
              BucketName: !Ref S3BucketData

  ExportPassFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: handlers/exportPass/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          S3_BUCKET_DATA: !Ref S3BucketData
          EXPIRY_TIME: !Ref ExportExpiryTime
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKSURI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
          - S3FullAccessPolicy:
              BucketName: !Ref S3BucketData
      Events:
        exportPassGet:
          Type: Api
          Properties:
            Path: /export-pass
            Method: GET
            RestApiId: !Ref ApiDeployment
        exportPassOptions:
          Type: Api
          Properties:
            Path: /export-pass
            Method: OPTIONS
            RestApiId: !Ref ApiDeployment

  PurgeExpired:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/purgeExpired/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
          - SQSSendMessagePolicy:
              QueueName: !GetAtt SqsExpiryQueue.QueueName
      Events:
        sqsExpiryEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt SqsExpiryQueue.Arn
            


  ReadConfigFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: handlers/readConfig/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        readConfigGet:
          Type: Api
          Properties:
            Path: /config
            Method: GET
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true
        readConfigOptions:
          Type: Api
          Properties:
            Path: /config
            Method: OPTIONS
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true
 
  ReadFacilityFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: handlers/readFacility/
>>>>>>> 00b1f9f... Sam Build Files
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
<<<<<<< HEAD
          EXPORT_FUNCTION_NAME: !Ref ExportFunctionName
          EXPORT_EXPIRY_TIME: !Ref ExportExpiryTime
          S3_BUCKET_DATA: !Ref S3BucketData
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          SSO_ISSUER: !Ref SSOIssuer
          SSO_JWKSURI: !Ref SSOJWKSUri
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
          - !Ref ExportAllPassLayer
      Events:
        exportAllPass:
          Type: Api
          Properties:
            Path: /export-all-pass
            Method: get

  CloudWatchFunction:
      Type: AWS::Serverless::Function
      Properties:
        CodeUri: cloudWatchAlarm/
        Timeout: 60
        Handler: index.handler
        Runtime: nodejs18.x
        Layers:
            - !Ref BaseLayer
        Environment:
          Variables:
            AWS_ACCOUNT_LIST: !Ref AWSAccountList
            WEBHOOK_URL: !Ref WebHookURL
            METRICS_TABLE_NAME: !Ref MetricsTableName
            META_TABLE_NAME: !Ref MetaTableName
            LOG_LEVEL: !Ref LogLevel
        Events:
          MyCloudWatchEvent:
            Type: CloudWatchEvent
            Properties:
              Pattern:
                source:
                  - "aws.cloudwatch"
                detail-type:
                  - "Scheduled Event"

  MetricFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: metric/
      Handler: index.handler
      Timeout: 60
      Runtime: nodejs18.x
      Environment:
        Variables:
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          SSO_ISSUER: !Ref SSOIssuer
          SSO_JWKSURI: !Ref SSOJWKSUri
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
      Events:
        metric:
          Type: Api
          Properties:
            Path: /metric
            Method: get

  writeMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: writeMetrics/
      Timeout: 60
=======
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKS_URI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        readFacilityGet:
          Type: Api
          Properties:
            Path: /facility
            Method: GET
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true
        readFacilityOptions:
          Type: Api
          Properties:
            Path: /facility
            Method: OPTIONS
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true

  ReadFaqFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: handlers/readFaq/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        readFaqGet:
          Type: Api
          Properties:
            Path: /faq
            Method: GET
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true
        readFaqOptions:
          Type: Api
          Properties:
            Path: /faq
            Method: OPTIONS
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true

  ReadMetricsFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: handlers/readMetrics/
>>>>>>> 00b1f9f... Sam Build Files
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
<<<<<<< HEAD
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          MODERATE_CAPACITY_THRESHOLD: !Ref ModerateCapacityThreshold
          LOW_CAPACITY_THRESHOLD: !Ref LowCapacityThreshold
      Layers:
          - !Ref MetricsLayer
          - !Ref BaseLayer
          - !Ref ReservationLayer
      Events:
          writeMetrics:
            Type: Schedule
            Properties:
              Schedule: "cron(0 0 * * ? *)" # Errr night at midnight
          
  WriteParkFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: writePark/
      Timeout: 60
=======
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKS_URI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        readMetricsGet:
          Type: Api
          Properties:
            Path: /metrics
            Method: GET
            RestApiId: !Ref ApiDeployment
        readMetricsOptions:
          Type: Api
          Properties:
            Path: /metrics
            Method: OPTIONS
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true

  ReadParkFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: handlers/readPark/
>>>>>>> 00b1f9f... Sam Build Files
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
<<<<<<< HEAD
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          SSO_ISSUER: !Ref SSOIssuer
          SSO_JWKSURI: !Ref SSOJWKSUri
      Layers:
          - !Ref PermissionLayer
          - !Ref BaseLayer
      Events:
        writePark:
          Type: Api
          Properties:
            Path: /park
            Method: post
        putFacility:
          Type: Api
          Properties:
            Path: /park
            Method: put

  WriteFacilityFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: writeFacility/
      Timeout: 60
=======
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKSURI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        readParkGet:
          Type: Api
          Properties:
            Path: /park
            Method: GET
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true
        readParkOptions:
          Type: Api
          Properties:
            Path: /park
            Method: OPTIONS
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true

  ReadPassFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: handlers/readPass/
>>>>>>> 00b1f9f... Sam Build Files
      Handler: index.handler
      Runtime: nodejs18.x
      Environment:
        Variables:
<<<<<<< HEAD
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          SSO_ISSUER: !Ref SSOIssuer
          SSO_JWKSURI: !Ref SSOJWKSUri
          MODERATE_CAPACITY_THRESHOLD: !Ref ModerateCapacityThreshold
          LOW_CAPACITY_THRESHOLD: !Ref LowCapacityThreshold
      Layers:
          - !Ref PermissionLayer
          - !Ref BaseLayer
          - !Ref ReservationLayer
          - !Ref FacilityLayer
      Events:
        writeFacility:
          Type: Api
          Properties:
            Path: /facility
            Method: post
        putFacility:
          Type: Api
          Properties:
            Path: /facility
            Method: put


############
  PutPassFunction:
      Type: AWS::Serverless::Function
      Properties: 
        CodeUri: writePass/
        Timeout: 60
        Handler: index.handler
        Environment:
          Variables:
            PUBLIC_FRONTEND: !Ref PublicFrontend
            PASS_CANCELLATION_ROUTE: !Ref PassCancellationRoute
            GC_NOTIFY_TRAIL_RECEIPT_TEMPLATE_ID: !Ref GCNotifyTrailReceiptTemplateID
            GC_NOTIFY_PARKING_RECEIPT_TEMPLATE_ID: !Ref GCNotifyParkingReceiptTemplateID
            METRICS_TABLE_NAME: !Ref MetricsTableName
            META_TABLE_NAME: !Ref MetaTableName
            LOG_LEVEL: !Ref LogLevel
            PASS_MANAGEMENT_ROUTE: !Ref PassManagementRoute
            ADMIN_FRONTEND: !Ref AdminFrontEnd
            JWT_SECRET: !Ref JWTSecret
            JWT_SIGN_EXPIRY: !Ref JWTSignExpiry
            PRIVATE_KEY: !Ref PrivateKey
            AWS_DEFAULT_REGION: !Ref AWSDefaultRegion
            ALGORITH: !Ref Algorithm
            SQSQUEUENAME: !Ref SqsQueueName
            AWS_REGION: !Ref AWSRegion
            SSO_ISSUER: !Ref SSOIssuer
            SSO_JWKSURI: !Ref SSOJWKSUri
            MODERATE_CAPACITY_THRESHOLD: !Ref ModerateCapacityThreshold
            LOW_CAPACITY_THRESHOLD: !Ref LowCapacityThreshold
        Layers:
          - !Ref CaptchaLayer
          - !Ref PassLayer
          - !Ref SQSLayer
          - !Ref ReservationLayer
          - !Ref BaseLayer
          - !Ref PermissionLayer
        Runtime: nodejs18.x
        Architectures:
          - x86_64
        Events:
          putPass:
            Type: Api
            Properties:
              Path: /pass
              Method: put

  WritePassFunction:
      Type: AWS::Serverless::Function
      Properties: 
        CodeUri: writePass/
        Timeout: 60
        Handler: index.handler
        Environment:
          Variables:
            METRICS_TABLE_NAME: !Ref MetricsTableName
            META_TABLE_NAME: !Ref MetaTableName
            LOG_LEVEL: !Ref LogLevel
            PASS_MANAGEMENT_ROUTE: !Ref PassManagementRoute
            ADMIN_FRONTEND: !Ref AdminFrontEnd
            JWT_SECRET: !Ref JWTSecret
            JWT_SIGN_EXPIRY: !Ref JWTSignExpiry
            PRIVATE_KEY: !Ref PrivateKey
            AWS_DEFAULT_REGION: !Ref AWSDefaultRegion
            ALGORITH: !Ref Algorithm
            SQSQUEUENAME: !Ref SqsQueueName
            AWS_REGION: !Ref AWSRegion
            SSO_ISSUER: !Ref SSOIssuer
            SSO_JWKSURI: !Ref SSOJWKSUri
            MODERATE_CAPACITY_THRESHOLD: !Ref ModerateCapacityThreshold
            LOW_CAPACITY_THRESHOLD: !Ref LowCapacityThreshold
        Layers:
          - !Ref CaptchaLayer
          - !Ref PassLayer
          - !Ref SQSLayer
          - !Ref ReservationLayer
          - !Ref BaseLayer
          - !Ref PermissionLayer

        Runtime: nodejs18.x
        Architectures:
          - x86_64
        Events:
          writePass:
            Type: Api
            Properties:
              Path: /pass
              Method: post
  
  DeletePassFunction:
      Type: AWS::Serverless::Function
      Properties: 
        CodeUri: deletePass/
        Timeout: 60
        Handler: index.handler
        Environment:
          Variables:
            ALGORITHM: !Ref Algorithm
            JWT_SECRET: !Ref JWTSecret
            METRICS_TABLE_NAME: !Ref MetricsTableName
            META_TABLE_NAME: !Ref MetaTableName
            LOG_LEVEL: !Ref LogLevel
            SSO_ISSUER: !Ref SSOIssuer
            SSO_JWKSURI: !Ref SSOJWKSUri
        Layers:
          - !Ref PermissionLayer
          - !Ref BaseLayer
        Runtime: nodejs18.x
        Architectures:
          - x86_64
        Events:
          deletePass:
            Type: Api
            Properties:
              Path: /pass
              Method: delete

  ExportPassFunction:
      Type: AWS::Serverless::Function
      Properties: 
        CodeUri: exportPass/
        Timeout: 60
        Handler: index.handler
        Environment:
          Variables:
            TABLE_NAME: !Ref TableName
            S3_BUCKET_DATA: !Ref S3BucketData
            METRICS_TABLE_NAME: !Ref MetricsTableName
            META_TABLE_NAME: !Ref MetaTableName
            LOG_LEVEL: !Ref LogLevel
            SSO_ISSUER: !Ref SSOIssuer
            SSO_JWKSURI: !Ref SSOJWKSUri
        Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
        Runtime: nodejs18.x
        Architectures:
          - x86_64
        Events:
          exportPass:
            Type: Api
            Properties:
              Path: /export-pass
              Method: get

  ReadMetricsFunction:
      Type: AWS::Serverless::Function
      Properties: 
        CodeUri: readMetrics/
        Timeout: 60
        Handler: index.handler
        Environment:
          Variables:
            METRICS_TABLE_NAME: !Ref MetricsTableName
            META_TABLE_NAME: !Ref MetaTableName
            LOG_LEVEL: !Ref LogLevel
            SSO_ISSUER: !Ref SSOIssuer
            SSO_JWKSURI: !Ref SSOJWKSUri
        Layers:
          - !Ref PermissionLayer
          - !Ref BaseLayer
        Runtime: nodejs18.x
        Architectures:
          - x86_64
        Events:
          readMetrics:
            Type: Api
            Properties:
              Path: /metrics
              Method: get
#############_ STEP 2
  ReadParkFunction:
      Type: AWS::Serverless::Function
      Properties: 
        CodeUri: readPark/
        Timeout: 60
        Handler: index.handler
        Environment:
          Variables:
            METRICS_TABLE_NAME: !Ref MetricsTableName
            META_TABLE_NAME: !Ref MetaTableName
            LOG_LEVEL: !Ref LogLevel
            SSO_ISSUER: !Ref SSOIssuer
            SSO_JWKSURI: !Ref SSOJWKSUri
        Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
        Runtime: nodejs18.x
        Architectures:
          - x86_64
        Events:
          readPark:
            Type: Api
            Properties:
              Path: /park
              Method: get

  ReadPassFunction:
      Type: AWS::Serverless::Function
      Properties: 
        CodeUri: readPass/
        Timeout: 60
        Handler: index.handler
        Environment:
          Variables:
            ALOGIRTHM: !Ref Algorithm
            JWT_SECRET: !Ref JWTSecret
            PUBLIC_FRONTEND: !Ref PublicFrontend
            PASS_CANCELLATION_ROUTE: !Ref PassCancellationRoute
            GC_NOTIFY_API_PATH: !Ref GCNotifyApiPath
            GC_NOTIFY_CANCEL_TEMPLATE_ID: !Ref GCNotifyCancelTemplateID
            METRICS_TABLE_NAME: !Ref MetricsTableName
            META_TABLE_NAME: !Ref MetaTableName
            LOG_LEVEL: !Ref LogLevel
            SSO_ISSUER: !Ref SSOIssuer
            SSO_JWKSURI: !Ref SSOJWKSUri
        Layers:
          - !Ref PermissionLayer
          - !Ref BaseLayer
        Runtime: nodejs18.x
        Architectures:
          - x86_64
        Events:
          readPass:
            Type: Api
            Properties:
              Path: /pass
              Method: get

  ReadFaqFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: readFaq/
      Timeout: 60
      Handler: index.handler
      Environment:
        Variables:
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
        - !Ref BaseLayer
        - !Ref ResponseLayer
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Events:
        readFaq:
          Type: Api
          Properties:
            Path: /faq
            Method: get
  
  WriteFaqFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: writeFaq/
      Timeout: 60
      Handler: index.handler
      Environment:
        Variables:
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          SSO_ISSUER: !Ref SSOIssuer
          SSO_JWKSURI: !Ref SSOJWKSUri
      Layers:
        - !Ref BaseLayer
        - !Ref PermissionLayer
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Events:
        writeFaq:
          Type: Api
          Properties:
            Path: /faq
            Method: put
  
  ReadConfigFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: readConfig/
      Timeout: 60
      Handler: index.handler
<<<<<<< HEAD
      Environment:
        Variables:
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
        - !Ref BaseLayer
        - !Ref ResponseLayer
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Events:
        readConfig:
          Type: Api
          Properties:
            Path: /config
            Method: get
 
  ReadFacilityFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: readFacility/
      Timeout: 60
      Handler: index.handler
=======
      Runtime: nodejs20.x
>>>>>>> 29a2062... convert to use npm, update github actions
      Environment:
        Variables:
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          SSO_ISSUER: !Ref SSOIssuer
          SSO_JWKSURI: !Ref SSOJWKSUri
      Layers:
        - !Ref BaseLayer
        - !Ref PermissionLayer
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Events:
        readFacility:
          Type: Api
          Properties:
            Path: /facility
            Method: get
  
  ReadReservationFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: readReservation/
      Timeout: 60
      Handler: index.handler
      Environment:
        Variables:
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
          SSO_ISSUER: !Ref SSOIssuer
          SSO_JWKSURI: !Ref SSOJWKSUri
          MODERATE_CAPACITY_THRESHOLD: !Ref ModerateCapacityThreshold
          LOW_CAPACITY_THRESHOLD: !Ref LowCapacityThreshold
      Layers:
        - !Ref BaseLayer
        - !Ref PermissionLayer
        - !Ref ReservationLayer
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Events:
        readReservation:
          Type: Api
          Properties:
            Path: /reservation
            Method: get
  
  ###JOBS??###
  CheckActivationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: checkActivation/
      Timeout: 60
      Handler: index.handler
      Environment:
        Variables:
          METRICS_TABLE_NAME: !Ref MetricsTableName
          META_TABLE_NAME: !Ref MetaTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
        - !Ref BaseLayer
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Events:
        ScheduleEvent:
          Type: Schedule
          Properties:
            Schedule: "cron(0 0 * * ? *)" # Errr night at midnight
  
  SendReminderFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: sendReminder/
      Timeout: 60
      Handler: index.handler
      Environment:
        Variables:
          GC_NOTIFY_IS_SENDING_REMINDERS: !Ref GCNotifyIsSendingReminders
          PASS_SHORTDATE_INDEX: !Ref PassShortdateIndex
          GC_NOTIFY_REMINDER_TEMPLATE_ID: !Ref GCNotifyReminderTemplateID
          GC_NOTIFY_API_BULK_PATH: !Ref GCNotifyApiBulkPath
          GC_NOTIFY_API_KEY: !Ref GCNotifyApiKey
          WEBHOOK_URL: !Ref WebHookURL
          PUBLIC_FRONTEND: !Ref PublicFrontend
          PASS_CANCELLATION_ROUTE: !Ref PassCancellationRoute
          GC_NOTIFY_SMS_TEMPLATE_ID: !Ref GCNotifySMSTemplateID
          GC_NOTIFY_API_SMS_PATH: !Ref GCNotifyApiSMSPath
          TABLE_NAME: !Ref TableName
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
        - !Ref GCNotifyLayer
        - !Ref WebHookLayer
        - !Ref SMSLayer
        - !Ref DynamoDBLayer
        - !Ref ResponseLayer
        - !Ref LoggerLayer
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Events:
        ScheduleEvent:
          Type: Schedule
          Properties:
            Schedule: "cron(0 0 * * ? *)" # Errr night at midnight

  CheckExpiryFunction:
      Type: AWS::Serverless::Function
      Properties: 
        CodeUri: checkExpiry/
        Timeout: 60
        Handler: index.handler
        Environment:
          Variables:
            METRICS_TABLE_NAME: !Ref MetricsTableName
            META_TABLE_NAME: !Ref MetaTableName
            LOG_LEVEL: !Ref LogLevel
        Layers:
          - !Ref BaseLayer
        Runtime: nodejs18.x
        Architectures:
          - x86_64
        Events:
          ScheduleEvent:
            Type: Schedule
            Properties:
              Schedule: "cron(0 0 * * ? *)" # Errr night at midnight
=======
          ALGORITHM: !Ref Algorithm
          JWT_SECRET: !Ref JWTSecret
          PUBLIC_FRONTEND: !Ref PublicFrontend
          PASS_CANCELLATION_ROUTE: !Ref GCNotifyPassCancellationRoute
          GC_NOTIFY_API_PATH: !Ref GCNotifyApiPath
          GC_NOTIFY_API_KEY: !Ref GCNotifyApiKey
          GC_NOTIFY_CANCEL_TEMPLATE_ID: !Ref GCNotifyCancelTemplateID
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKSURI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        readPassGet:
          Type: Api
          Properties:
            Path: /pass
            Method: GET
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true
        readPassOptions:
          Type: Api
          Properties:
            Path: /pass
            Method: OPTIONS
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true

  ReadReservationFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: handlers/readReservation/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          LOW_CAPACITY_THRESHOLD: !Ref LowCapacityThreshold
          MODERATE_CAPACITY_THRESHOLD: !Ref ModerateCapacityThreshold
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKSURI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
          - !Ref ReservationLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        readReservationGet:
          Type: Api
          Properties:
            Path: /reservation
            Method: GET
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true
        readReservationOptions:
          Type: Api
          Properties:
            Path: /reservation
            Method: OPTIONS
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true
  
  SendReminderFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/sendReminder/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          GC_NOTIFY_IS_SENDING_REMINDERS: !Ref GCNotifyIsSendingReminders
          PASS_SHORTDATE_INDEX: !Ref PassShortDateIndex
          GC_NOTIFY_REMINDER_TEMPLATE_ID: !Ref GCNotifyReminderTemplateID
          GC_NOTIFY_API_BULK_PATH: !Ref GCNotifyApiBulkPath
          GC_NOTIFY_API_KEY: !Ref GCNotifyApiKey
          WEBHOOK_URL: !Ref WebHookURL
          PUBLIC_FRONTEND: !Ref PublicFrontend
          PASS_CANCELLATION_ROUTE: !Ref GCNotifyPassCancellationRoute
          GC_NOTIFY_SMS_TEMPLATE_ID: !Ref GCNotifySMSTemplateID
          GC_NOTIFY_API_SMS_PATH: !Ref GCNotifyApiSMSPath
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref GCNotifyLayer
          - !Ref WebHookLayer
          - !Ref SMSLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        ScheduleEvent:
          Type: Schedule
          Properties:
            Schedule: "cron(0 0 * * ? *)" #  Every night at midnight

  SendSurveyFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/sendSurvey/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          PASS_SHORTDATE_INDEX: !Ref PassShortDateIndex
          FEEDBACK_SURVEY_URL: !Ref FeedbackSurveyUrl
          GC_NOTIFY_IS_SENDING_SURVEYS: !Ref GCNotifyIsSendingSurveys
          GC_NOTIFY_SURVEY_TEMPLATE_ID: !Ref GCNotifySurveyTemplateID
          GC_NOTIFY_API_BULK_PATH: !Ref GCNotifyApiBulkPath
          GC_NOTIFY_API_KEY: !Ref GCNotifyApiKey
          WEBHOOK_URL: !Ref WebHookURL
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKS_URI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref WebHookLayer
          - !Ref GCNotifyLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName

  SQSProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/sqsProcessor/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          GC_NOTIFY_API_PATH: !Ref GCNotifyApiPath
          GC_NOTIFY_API_KEY: !Ref GCNotifyApiKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer  
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        sqsGcnEmailEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt SqsGcnEmailQueue.Arn

  UpdateParkNameFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/updateParkName/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          DATA_REGISTER_URL: !Ref DataRegisterApiPath
          DATA_REGISTER_NAME_API_KEY: !Ref DataRegisterApiKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref DataRegisterLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName

  WarmupFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/warmup/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName

  WriteConfigFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/writeConfig/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        writeConfigPost:
          Type: Api
          Properties:
            Path: /config
            Method: POST
            RestApiId: !Ref ApiDeployment

  WriteMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/writeMetrics/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          LOW_CAPACITY_THRESHOLD: !Ref LowCapacityThreshold
          MODERATE_CAPACITY_THRESHOLD: !Ref ModerateCapacityThreshold
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref MetricsLayer
          - !Ref ReservationLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
          writeMetrics:
            Type: Schedule
            Properties:
              Schedule: "cron(0 0 * * ? *)" # Every night at midnight

  WriteModifierFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/writeModifier/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          MODERATE_CAPACITY_THRESHOLD: !Ref ModerateCapacityThreshold
          LOW_CAPACITY_THRESHOLD: !Ref LowCapacityThreshold
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKSURI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
          - !Ref FacilityLayer
          - !Ref ReservationLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName    
      Events:
        writeModifierPut:
          Type: Api
          Properties:
            Path: /modifier
            Method: PUT
            RestApiId: !Ref ApiDeployment
          
  WriteParkFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/writePark/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKS_URI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName  
      Events:
        writeParkPost:
          Type: Api
          Properties:
            Path: /park
            Method: POST
            RestApiId: !Ref ApiDeployment
        writeParkPut:
          Type: Api
          Properties:
            Path: /park
            Method: PUT
            RestApiId: !Ref ApiDeployment

  WriteFacilityFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/writeFacility/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          LOW_CAPACITY_THRESHOLD: !Ref LowCapacityThreshold
          MODERATE_CAPACITY_THRESHOLD: !Ref ModerateCapacityThreshold
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKSURI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
          - !Ref BaseLayer
          - !Ref PermissionLayer
          - !Ref ReservationLayer
          - !Ref FacilityLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        writeFacility:
          Type: Api
          Properties:
            Path: /facility
            Method: POST
            RestApiId: !Ref ApiDeployment
        putFacility:
          Type: Api
          Properties:
            Path: /facility
            Method: PUT
            RestApiId: !Ref ApiDeployment

  WriteFaqFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: handlers/writeFaq/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKSURI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
        - !Ref BaseLayer
        - !Ref PermissionLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
      Events:
        writeFaq:
          Type: Api
          Properties:
            Path: /faq
            Method: PUT
            RestApiId: !Ref ApiDeployment

  WritePassFunction:
    Type: AWS::Serverless::Function
    Properties: 
      CodeUri: handlers/writePass/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          ALGORITHM: !Ref Algorithm
          GC_NOTIFY_PARKING_RECEIPT_TEMPLATE_ID: !Ref GCNotifyParkingReceiptTemplateID
          GC_NOTIFY_TRAIL_RECEIPT_TEMPLATE_ID: !Ref GCNotifyTrailReceiptTemplateID
          PASS_CANCELLATION_ROUTE: !Ref GCNotifyPassCancellationRoute
          PASS_MANAGEMENT_ROUTE: !Ref GCNotifyPassManagementRoute
          ADMIN_FRONTEND: !Ref AdminFrontEnd
          JWT_SECRET: !Ref JWTSecret
          HOLD_PASS_TIMEOUT: !Ref HoldPassTimeout
          SQSQUEUENAME: !Ref SqsGCNQueueName
          SQSEXPIRY_QUEUE: !Ref SqsExpiryQueueName
          LOW_CAPACITY_THRESHOLD: !Ref LowCapacityThreshold
          MODERATE_CAPACITY_THRESHOLD: !Ref ModerateCapacityThreshold
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKSURI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          TABLE_NAME: !Ref TableNameParks
          META_TABLE_NAME: !Ref MetaTableName
          METRICS_TABLE_NAME: !Ref MetricsTableName
          LOG_LEVEL: !Ref LogLevel
      Layers:
        - !Ref BaseLayer
        - !Ref PermissionLayer
        - !Ref PassLayer
        - !Ref JWTLayer
        - !Ref ReservationLayer
      Policies:
          - DynamoDBCrudPolicy:
              TableName: !Ref TableNameParks
          - DynamoDBCrudPolicy:
              TableName: !Ref MetaTableName
          - DynamoDBCrudPolicy:
              TableName: !Ref MetricsTableName
          - SQSSendMessagePolicy:
              QueueName: !GetAtt SqsExpiryQueue.QueueName
          - SQSSendMessagePolicy:
              QueueName: !GetAtt SqsGcnEmailQueue.QueueName
      Events:
        writePassPost:
          Type: Api
          Properties:
            Path: /pass
            Method: POST
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true
        writePassPut:
          Type: Api
          Properties:
            Path: /pass
            Method: PUT
            RestApiId: !Ref ApiDeployment
            Auth:
              Authorizer: NONE
              OverrideApiAuth: true

  #################
  # DynamoDB Tables
  #################
  ParksDUP:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Ref TableNameParks
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
        - AttributeName: shortPassDate
          AttributeType: S
        - AttributeName: passStatus
          AttributeType: S
        - AttributeName: facilityName
          AttributeType: S
      GlobalSecondaryIndexes:
        - IndexName: manualLookup-index
          KeySchema:
            - AttributeName: shortPassDate
              KeyType: HASH
            - AttributeName: facilityName
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: passStatus-index
          KeySchema:
            - AttributeName: passStatus
              KeyType: HASH
          Projection:
            ProjectionType: INCLUDE
            NonKeyAttributes:
              - pk
              - sk
              - date
              - type
        - IndexName: shortPassDate-index
          KeySchema:
            - AttributeName: shortPassDate
              KeyType: HASH
            - AttributeName: facilityName
              KeyType: RANGE
          Projection:
            ProjectionType: INCLUDE
            NonKeyAttributes:
              - phoneNumber
              - parkName
              - facilityType
              - lastName
              - creationDate
              - email
              - searchLastName
              - firstName
              - numberOfGuests
              - license
              - date
              - searchFirstName
              - pk
              - registrationNumber
              - isOverbooked
              - passStatus
              - type
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES

  ParksMetaDUP:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Ref MetaTableName
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES

  ParksMetricsDUP:
    Type: "AWS::DynamoDB::Table"
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Ref MetricsTableName
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES

  #############
  # Authorizer
  #############
  Authorizer:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handlers/authorizer/
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables:
          SSO_ISSUER: !Ref SSOIssuerUrl
          SSO_JWKSURI: !Ref SSOJWKSUri
          CF_SECRET_KEY: !Ref CFSecretKey
          LOG_LEVEL: !Ref LogLevel
      Layers:
        - !Ref BaseLayer
        - !Ref PermissionLayer

  ######
  # API
  ######
  ApiDeployment:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Stage
      Cors:
        AllowMethods: "'POST,GET,OPTIONS,PUT,DELETE'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-App-Version'"
        AllowOrigin: "'*'"
        MaxAge: "'600'"
      Auth:
        DefaultAuthorizer: KCAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          KCAuthorizer:
            FunctionPayloadType: REQUEST
            FunctionArn: !GetAtt Authorizer.Arn
            Identity:
              Headers:
                - Authorization

  ############ 
  # S3 Bucket
  ############
  ParksArAssetsS3Bucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Ref S3BucketData

  #############
  # SQS Queues
  #############
  SqsGcnEmailQueue:
    Type: 'AWS::SQS::Queue'
    Properties:
      QueueName: !Ref SqsGCNQueueName

  SqsExpiryQueue:
    Type: 'AWS::SQS::Queue'
    Properties:
      QueueName: !Ref SqsExpiryQueueName
      
Outputs:
  ApiDeployment:
    Description: 'API Gateway endpoint URL for Stage for Config function'
    Value: !Sub 'https://${ApiDeployment}.execute-api.${AWS::Region}.amazonaws.com/${Stage}/config/'
>>>>>>> 00b1f9f... Sam Build Files
